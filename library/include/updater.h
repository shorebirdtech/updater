#ifndef updater_h
#define updater_h

/* Warning, this file is autogenerated by cbindgen. Don't modify this manually. */

#include <stdarg.h>
#include <stdbool.h>
#include <stdint.h>
#include <stdlib.h>
#ifdef _WIN32
#define SHOREBIRD_EXPORT __declspec(dllexport)
#else
#define SHOREBIRD_EXPORT __attribute__((visibility("default")))
#endif


typedef void *(*OpenAssetFn)(const char *name);

typedef int (*GetAssetLengthFn)(void *asset);

typedef int (*ReadAssetFn)(void *asset, void *buffer, size_t size);

typedef off_t (*SeekAssetFn)(void *asset, off_t offset, int whence);

typedef void (*CloseAssetFn)(void *asset);

/**
 * Struct containing callbacks to open, read, and close assets.
 * Passed as part of AppParameters to shorebird_init().  shorebird_init()
 * will copy the contents of this struct, so it is safe to free the memory
 * after calling shorebird_init().
 */
typedef struct AssetProvider {
  OpenAssetFn open_asset;
  GetAssetLengthFn get_asset_length;
  ReadAssetFn read_asset;
  SeekAssetFn seek_asset;
  CloseAssetFn close_asset;
} AssetProvider;

/**
 * Struct containing configuration parameters for the updater.
 * This struct is passed to shorebird_init().  shorebird_init() will
 * copy the contents of this struct, so it is safe to free the memory
 * after calling shorebird_init().
 */
typedef struct AppParameters {
  /**
   * release_version, required.  Named version of the app, off of which updates
   * are based.  Can be either a version number or a hash.
   */
  const char *release_version;
  /**
   * Array of paths to the original aot library, required.  For Flutter apps
   * these are the paths to the bundled libapp.so.  May be used for compression downloaded artifacts.
   */
  const char *const *original_libapp_paths;
  /**
   * Length of the original_libapp_paths array.
   */
  int original_libapp_paths_size;
  /**
   * A pointer to AAssetManager, required.  Used to resolve libapp.so.
   */
  const struct AssetProvider *asset_provider;
  /**
   * Path to cache_dir where the updater will store downloaded artifacts.
   */
  const char *cache_dir;
} AppParameters;

#ifdef __cplusplus
extern "C" {
#endif // __cplusplus

/**
 * Configures updater.  First parameter is a struct containing configuration
 * from the running app.  Second parameter is a YAML string containing
 * configuration compiled into the app.
 */
SHOREBIRD_EXPORT
void shorebird_init(const struct AppParameters *c_params,
                    const char *c_yaml);

/**
 * Return the active patch number, or NULL if there is no active patch.
 */
SHOREBIRD_EXPORT char *shorebird_active_patch_number(void);

/**
 * Return the path to the active patch for the app, or NULL if there is no
 * active patch.
 */
SHOREBIRD_EXPORT char *shorebird_active_path(void);

/**
 * Free a string returned by the updater library.
 */
SHOREBIRD_EXPORT void shorebird_free_string(char *c_string);

/**
 * Check for an update.  Returns true if an update is available.
 */
SHOREBIRD_EXPORT bool shorebird_check_for_update(void);

/**
 * Synchronously download an update if one is available.
 */
SHOREBIRD_EXPORT void shorebird_update(void);

/**
 * Report that the app failed to launch.  This will cause the updater to
 * attempt to roll back to the previous version if this version has not
 * been launched successfully before.
 */
SHOREBIRD_EXPORT void shorebird_report_failed_launch(void);

#ifdef __cplusplus
} // extern "C"
#endif // __cplusplus

#endif /* updater_h */
